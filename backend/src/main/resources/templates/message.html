<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - NYU Activity Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .message-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }
        .message-item.unread {
            background: #e3f2fd;
            border-color: #2196f3;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/main">NYU Activity Center</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/main">Events</a>
                <a class="nav-link" href="/square">Posts</a>
                <a class="nav-link active" href="/message">Messages</a>
                <a class="nav-link" th:if="${isAdmin}" href="/admin">Admin</a>
                <a class="nav-link" th:if="${user}" th:href="@{/profile(userID=${user.id})}">Profile</a>
            </div>
        </div>
    </nav>

    <div class="message-container">
        <h2 class="mb-4">My Messages</h2>
        <div id="messageList">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Get userId parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('userId');
        
        async function loadMessages() {
            const token = getTokenOrRedirect();
            if (!token) {
                return; // Already redirected
            }
            console.log('Loading messages with token, targetUserId:', targetUserId);

            // 如果有userId参数，加载私聊对话
            if (targetUserId) {
                await loadChatMessages(token, targetUserId);
            } else {
                // 否则加载所有聊天列表
                await loadChatList(token);
            }
        }

        async function loadChatList(token) {
            try {
                const response = await fetch('/message/chat', {
                    headers: { 'Authorization': token }
                });
                if (response.ok) {
                    const result = await response.json();
                    const chatList = Array.isArray(result) ? result : (result.data || []);
                    renderChatList(chatList);
                }
            } catch (error) {
                console.error('Failed to load chat list:', error);
                document.getElementById('messageList').innerHTML = '<p>Failed to load</p>';
            }
        }

        function renderChatList(chatList) {
            const container = document.getElementById('messageList');
            if (chatList.length === 0) {
                container.innerHTML = '<p class="text-center">No chats yet</p>';
                return;
            }
            container.innerHTML = chatList.map(chat => {
                const chatData = typeof chat === 'string' ? JSON.parse(chat) : chat;
                return `
                    <div class="message-item ${chatData.hasUnread ? 'unread' : ''}" onclick="window.location.href='/message?userId=${chatData.userId}'" style="cursor: pointer;">
                        <h5>${chatData.userName || 'Unknown User'}</h5>
                        ${chatData.hasUnread ? '<span class="badge bg-danger">Unread</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadChatMessages(token, friendId) {
            try {
                const response = await fetch(`/message/chatText?userId=${friendId}`, {
                    headers: { 'Authorization': token }
                });
                if (response.ok) {
                    const result = await response.json();
                    const messages = Array.isArray(result) ? result : (result.data || []);
                    renderChatMessages(messages, friendId);
                }
            } catch (error) {
                console.error('Failed to load chat messages:', error);
                document.getElementById('messageList').innerHTML = '<p>Failed to load</p>';
            }
        }

        function renderChatMessages(messages, friendId) {
            const container = document.getElementById('messageList');
            container.innerHTML = `
                <div class="mb-3">
                    <button class="btn btn-secondary" onclick="window.location.href='/message'">Back to Chat List</button>
                </div>
                <div id="chatMessages">
                    ${messages.map(msg => `
                        <div class="message-item">
                            <strong>${msg.fromName || 'Unknown User'}</strong>
                            <p>${msg.content || ''}</p>
                            <small class="text-muted">${formatTime(msg.time)}</small>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="Enter message...">
                        <button class="btn btn-primary" onclick="sendChatMessage(${friendId})">Send</button>
                    </div>
                </div>
            `;
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage(friendId) {
            const token = getToken();
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;

            const now = new Date();
            const timeStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' +
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');

            try {
                const formData = new FormData();
                formData.append('userId', friendId);
                formData.append('content', content);
                formData.append('time', timeStr);

                const response = await fetch('/message/sendChat', {
                    method: 'POST',
                    headers: { 'Authorization': token },
                    body: formData
                });

                if (response.ok) {
                    input.value = '';
                    // 重新加载Messages
                    await loadChatMessages(token, friendId);
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Failed to send');
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            return new Date(timeStr).toLocaleString('en-US');
        }

        window.addEventListener('DOMContentLoaded', loadMessages);
        
        // 支持回车发送
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('chatInput')) {
                const friendId = urlParams.get('userId');
                if (friendId) {
                    sendChatMessage(friendId);
                }
            }
        });
    </script>
</body>
</html>

