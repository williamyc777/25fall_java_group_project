<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - NYU Activity Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f7;
        }
        .page-wrapper {
            max-width: 1100px;
            margin: 0 auto;
            padding: 24px 16px 32px;
        }
        .message-layout {
            display: flex;
            gap: 16px;
        }
        .chat-list-panel,
        .chat-panel {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.1);
            padding: 16px 18px;
            height: 70vh;
            display: flex;
            flex-direction: column;
        }
        .chat-list-panel {
            width: 32%;
        }
        .chat-panel {
            width: 68%;
        }
        .message-item {
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 10px;
            background: #f9fafb;
            cursor: pointer;
            transition: background 0.12s ease, transform 0.12s ease;
        }
        .message-item:hover {
            background: #eef2ff;
            transform: translateY(-1px);
        }
        .message-item.unread {
            background: #e0f2fe;
            border: 1px solid #38bdf8;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 6px;
            margin-bottom: 12px;
        }
        .chat-bubble {
            border-radius: 14px;
            padding: 10px 12px;
            margin-bottom: 8px;
            max-width: 80%;
        }
        .chat-bubble.me {
            margin-left: auto;
            background: #4f46e5;
            color: #fff;
        }
        .chat-bubble.other {
            background: #e5e7eb;
        }
        .chat-meta {
            font-size: 0.75rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-semibold" href="/main">NYU Activity Center</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#messageNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="messageNavbar">
                <div class="navbar-nav ms-auto align-items-lg-center gap-lg-1">
                    <a class="nav-link" href="/main">Events</a>
                    <a class="nav-link" href="/square">Posts</a>
                    <a class="nav-link active" href="/message">Messages</a>
                    <a class="nav-link" th:if="${isAdmin}" href="/admin">Admin</a>
                    <a class="nav-link" th:if="${user}" th:href="@{/profile(userID=${user.id})}">Profile</a>
                    <a class="nav-link" th:if="${user == null}" href="/">Login</a>
                    <button class="btn btn-sm btn-outline-light ms-lg-2" type="button"
                            onclick="logout()" th:if="${user}">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-wrapper">
        <h2 class="mb-3">Messages</h2>
        <p class="text-muted mb-4">View your conversations or select a chat to start messaging.</p>

        <div class="message-layout">
            <!-- Left: chat list -->
            <div class="chat-list-panel">
                <h6 class="mb-3">Chats</h6>
                <div id="chatListContainer">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: chat detail / messages -->
            <div class="chat-panel">
                <div id="messageList" class="w-100 h-100 d-flex flex-column">
                    <div class="text-center m-auto text-muted">
                        Select a chat on the left to view messages.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        // Get userId parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('userId');
        
        async function loadMessages() {
            const token = getTokenOrRedirect();
            if (!token) {
                return; // Already redirected
            }
            console.log('Loading messages with token, targetUserId:', targetUserId);

            // 如果有userId参数，加载私聊对话
            if (targetUserId) {
                await loadChatMessages(token, targetUserId);
            } else {
                // 否则加载所有聊天列表
                await loadChatList(token);
            }
        }

        async function loadChatList(token) {
            try {
                const response = await fetch('/message/chat', {
                    headers: { 'Authorization': token }
                });
                if (response.ok) {
                    const result = await response.json();
                    const chatList = Array.isArray(result) ? result : (result.data || []);
                    renderChatList(chatList);
                }
            } catch (error) {
                console.error('Failed to load chat list:', error);
                document.getElementById('messageList').innerHTML = '<p>Failed to load</p>';
            }
        }

        function renderChatList(chatList) {
            const container = document.getElementById('chatListContainer');
            if (chatList.length === 0) {
                container.innerHTML = '<p class="text-center">No chats yet</p>';
                return;
            }
            container.innerHTML = chatList.map(chat => {
                const chatData = typeof chat === 'string' ? JSON.parse(chat) : chat;
                return `
                    <div class="message-item ${chatData.hasUnread ? 'unread' : ''}" onclick="window.location.href='/message?userId=${chatData.userId}'">
                        <h5>${chatData.userName || 'Unknown User'}</h5>
                        ${chatData.hasUnread ? '<span class="badge bg-danger">Unread</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadChatMessages(token, friendId) {
            try {
                const response = await fetch(`/message/chatText?userId=${friendId}`, {
                    headers: { 'Authorization': token }
                });
                if (response.ok) {
                    const result = await response.json();
                    const messages = Array.isArray(result) ? result : (result.data || []);
                    renderChatMessages(messages, friendId);
                }
            } catch (error) {
                console.error('Failed to load chat messages:', error);
                document.getElementById('messageList').innerHTML = '<p>Failed to load</p>';
            }
        }

        function renderChatMessages(messages, friendId) {
            const container = document.getElementById('messageList');
            container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/message'">
                        ← Back
                    </button>
                    <span class="text-muted small">Chat with User #${friendId}</span>
                </div>
                <div id="chatMessages" class="chat-messages">
                    ${messages.map(msg => `
                        <div class="d-flex ${msg.isSelf ? 'justify-content-end' : 'justify-content-start'}">
                            <div class="chat-bubble ${msg.isSelf ? 'me' : 'other'}">
                                <div class="fw-semibold mb-1">${msg.fromName || 'Unknown User'}</div>
                                <div>${msg.content || ''}</div>
                                <div class="chat-meta mt-1">${formatTime(msg.time)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-2">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="Enter message...">
                        <button class="btn btn-primary" onclick="sendChatMessage(${friendId})">Send</button>
                    </div>
                </div>
            `;
            const messagesDiv = document.getElementById('chatMessages');
            if (messagesDiv) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        async function sendChatMessage(friendId) {
            const token = getToken();
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;

            const now = new Date();
            const timeStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' +
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');

            try {
                const formData = new FormData();
                formData.append('userId', friendId);
                formData.append('content', content);
                formData.append('time', timeStr);

                const response = await fetch('/message/sendChat', {
                    method: 'POST',
                    headers: { 'Authorization': token },
                    body: formData
                });

                if (response.ok) {
                    input.value = '';
                    // 重新加载Messages
                    await loadChatMessages(token, friendId);
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Failed to send');
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            return new Date(timeStr).toLocaleString('en-US');
        }

        window.addEventListener('DOMContentLoaded', loadMessages);
        
        // 支持回车发送
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('chatInput')) {
                const friendId = urlParams.get('userId');
                if (friendId) {
                    sendChatMessage(friendId);
                }
            }
        });
    </script>
</body>
</html>

