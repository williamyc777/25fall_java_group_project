<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="format-detection" content="telephone=no">
    <title>Create Event - NYU Activity Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-semibold" href="/main">NYU Activity Center</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#createNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="createNavbar">
                <div class="navbar-nav ms-auto align-items-lg-center gap-lg-1">
                    <a class="nav-link" href="/main">Events</a>
                    <a class="nav-link" href="/square">Posts</a>
                    <a class="nav-link" href="/message">Messages</a>
                    <a class="nav-link" th:if="${user}" th:href="@{/profile(userID=${user.id})}">Profile</a>
                    <a class="nav-link" th:if="${user == null}" href="/">Login</a>
                    <button class="btn btn-sm btn-outline-light ms-lg-2" type="button"
                            onclick="logout()" th:if="${user}">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Create Event</h2>
        <form id="createEventForm" class="mt-4">
            <div class="mb-3">
                <label class="form-label">Event Title</label>
                <input type="text" class="form-control" name="title" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Name</label>
                <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Enrollment Type</label>
                <select class="form-select" name="enrollmentType" id="enrollmentType" required>
                    <option value="count">Capacity Limit</option>
                    <option value="form">Form Enrollment</option>
                </select>
            </div>
            <!-- Capacity enrollment settings -->
            <div class="mb-3" id="limitCountDiv" style="display: none;">
                <label class="form-label">Capacity Limit</label>
                <input type="number" class="form-control" name="limitCount" min="1">
            </div>

            <!-- Form enrollment builder -->
            <div class="mb-3" id="formBuilderDiv" style="display: none;">
                <label class="form-label">Enrollment Form Fields</label>
                <div class="border rounded p-3 bg-light">
                    <p class="text-muted small mb-2">
                        Configure the fields that participants need to fill in when applying for this event.
                    </p>
                    <div id="formFieldsContainer"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addFieldBtn">
                        + Add Field
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Enrollment Start Time</label>
                <input type="datetime-local" class="form-control" name="applyStartTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Enrollment End Time</label>
                <input type="datetime-local" class="form-control" name="applyEndTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Start Time</label>
                <input type="datetime-local" class="form-control" name="startTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event End Time</label>
                <input type="datetime-local" class="form-control" name="endTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Introduction</label>
                <textarea class="form-control" name="introduction" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Details (Markdown)</label>
                <textarea class="form-control" name="mdText" rows="10"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Poster URL</label>
                <input type="url" class="form-control" name="imageUrl">
            </div>
            <button type="submit" class="btn btn-primary">Create Event</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        const enrollmentTypeSelect = document.getElementById('enrollmentType');
        const limitCountDiv = document.getElementById('limitCountDiv');
        const formBuilderDiv = document.getElementById('formBuilderDiv');
        const formFieldsContainer = document.getElementById('formFieldsContainer');
        const addFieldBtn = document.getElementById('addFieldBtn');

        function updateEnrollmentUI() {
            const type = enrollmentTypeSelect.value;
            if (type === 'count') {
                limitCountDiv.style.display = 'block';
                // count 模式下必须填写人数上限
                const limitInput = limitCountDiv.querySelector('input[name="limitCount"]');
                if (limitInput) {
                    limitInput.required = true;
                }
                formBuilderDiv.style.display = 'none';
            } else {
                limitCountDiv.style.display = 'none';
                const limitInput = limitCountDiv.querySelector('input[name="limitCount"]');
                if (limitInput) {
                    limitInput.required = false;
                }
                formBuilderDiv.style.display = 'block';
                // 如果还没有字段，默认添加一个
                if (formFieldsContainer.querySelectorAll('.form-field-row').length === 0) {
                    addFormField('Contact information', 'input', true, '');
                }
            }
        }

        function addFormField(name = '', type = 'input', required = true, options = '') {
            const row = document.createElement('div');
            row.className = 'row g-2 align-items-end mb-2 form-field-row';
            row.innerHTML = `
                <div class="col-md-4">
                    <label class="form-label small mb-1">Field Name</label>
                    <input type="text" class="form-control form-field-name" value="${name}" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Type</label>
                    <select class="form-select form-field-type">
                        <option value="input" ${type === 'input' ? 'selected' : ''}>Text</option>
                        <option value="select" ${type === 'select' ? 'selected' : ''}>Select</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Options (for Select)</label>
                    <input type="text" class="form-control form-field-options" placeholder="Option1, Option2" value="${options}">
                </div>
                <div class="col-md-2 text-end">
                    <div class="form-check mb-1">
                        <input class="form-check-input form-field-required" type="checkbox" ${required ? 'checked' : ''}>
                        <label class="form-check-label small">Required</label>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-field-btn">Remove</button>
                </div>
            `;
            formFieldsContainer.appendChild(row);

            row.querySelector('.remove-field-btn').addEventListener('click', () => {
                row.remove();
            });
        }

        enrollmentTypeSelect.addEventListener('change', updateEnrollmentUI);
        addFieldBtn.addEventListener('click', () => addFormField());

        // 初始化一次
        updateEnrollmentUI();

        document.getElementById('createEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const token = getToken();
            
            if (!token) {
                alert('Please login first');
                window.location.href = '/';
                return;
            }

            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Format time
            data.applyStartTime = formatDateTime(data.applyStartTime);
            data.applyEndTime = formatDateTime(data.applyEndTime);
            data.startTime = formatDateTime(data.startTime);
            data.endTime = formatDateTime(data.endTime);

            // 构造表单报名字段
            if (data.enrollmentType === 'form') {
                const rows = formFieldsContainer.querySelectorAll('.form-field-row');
                const definedForm = [];
                rows.forEach(row => {
                    const nameInput = row.querySelector('.form-field-name');
                    const typeSelect = row.querySelector('.form-field-type');
                    const requiredCheckbox = row.querySelector('.form-field-required');
                    const optionsInput = row.querySelector('.form-field-options');

                    const fieldName = nameInput.value.trim();
                    if (!fieldName) {
                        return;
                    }

                    const rawOptions = optionsInput.value.trim();
                    const options = rawOptions
                        ? rawOptions.split(',').map(o => o.trim()).filter(o => o.length > 0)
                        : [];

                    definedForm.push({
                        id: 0,
                        name: fieldName,
                        type: typeSelect.value,        // 'input' or 'select'
                        required: !!requiredCheckbox.checked,
                        options: options
                    });
                });

                if (definedForm.length === 0) {
                    alert('Please add at least one form field for form enrollment.');
                    return;
                }

                data.definedForm = definedForm;
            } else {
                // count 类型保持结构一致，传空数组
                data.definedForm = [];
            }

            try {
                console.log('Creating event with data:', data);
                console.log('Formatted times - applyStartTime:', data.applyStartTime, 'startTime:', data.startTime);
                
                const response = await fetch('/event/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const responseText = await response.text();
                console.log('Response status:', response.status);
                console.log('Response text:', responseText);
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Parsed response:', result);
                        if (result.code === 0 || (result.data !== undefined && result.data === true)) {
                            alert('Event created successfully!');
                            window.location.href = '/event/manage';
                        } else {
                            alert('Failed to create: ' + (result.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        // 如果返回的是纯布尔值
                        if (responseText === 'true') {
                            alert('Event created successfully!');
                            window.location.href = '/event/manage';
                        } else {
                            alert('Failed to create: ' + responseText);
                        }
                    }
                } else {
                    try {
                        const error = JSON.parse(responseText);
                        alert('Failed to create: ' + (error.msg || error.message || 'HTTP ' + response.status));
                    } catch (e) {
                        alert('Failed to create: HTTP ' + response.status);
                    }
                }
            } catch (error) {
                console.error('Failed to create event:', error);
                alert('Failed to create: ' + error.message);
            }
        });

        function getToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'token') {
                    return value;
                }
            }
            return null;
        }

        function formatDateTime(dateTimeStr) {
            // 将 datetime-local 格式转换为 yyyy-MM-dd HH:mm:ss
            if (!dateTimeStr) return '';
            
            // datetime-local 输入框的格式可能是：
            // - yyyy-MM-ddTHH:mm (没有秒)
            // - yyyy-MM-ddTHH:mm:ss (有秒，如果 step="1")
            
            // 替换 T 为空格
            let formatted = dateTimeStr.replace('T', ' ');
            
            // 检查是否已经有秒数部分（格式：HH:mm:ss）
            const timePattern = /(\d{2}:\d{2})(:\d{2})?$/;
            const match = formatted.match(timePattern);
            
            if (match) {
                if (match[2]) {
                    // 已经有秒数部分，直接返回
                    return formatted;
                } else {
                    // 没有秒数部分，添加 :00
                    return formatted + ':00';
                }
            }
            
            // 如果格式不匹配，尝试添加 :00
            return formatted + ':00';
        }
    </script>
</body>
</html>


