<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="format-detection" content="telephone=no">
    <title>Create Event - NYU Activity Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/main">NYU Activity Center</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/main">Events</a>
                <a class="nav-link" href="/square">Posts</a>
                <a class="nav-link" href="/message">Messages</a>
                <a class="nav-link" th:if="${user}" th:href="@{/profile(userID=${user.id})}">Profile</a>
                <a class="nav-link" th:if="${user == null}" href="/">Login</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>Create Event</h2>
        <form id="createEventForm" class="mt-4">
            <div class="mb-3">
                <label class="form-label">Event Title</label>
                <input type="text" class="form-control" name="title" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Name</label>
                <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Enrollment Type</label>
                <select class="form-select" name="enrollmentType" id="enrollmentType" required>
                    <option value="count">Capacity Limit</option>
                    <option value="form">Form Enrollment</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Enrollment Start Time</label>
                <input type="datetime-local" class="form-control" name="applyStartTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Enrollment End Time</label>
                <input type="datetime-local" class="form-control" name="applyEndTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Start Time</label>
                <input type="datetime-local" class="form-control" name="startTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event End Time</label>
                <input type="datetime-local" class="form-control" name="endTime" required lang="en" step="1">
                <small class="form-text text-muted">Format: MM/DD/YYYY, HH:MM</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Introduction</label>
                <textarea class="form-control" name="introduction" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Details (Markdown)</label>
                <textarea class="form-control" name="mdText" rows="10"></textarea>
            </div>
            <div class="mb-3" id="limitCountDiv" style="display: none;">
                <label class="form-label">Capacity Limit</label>
                <input type="number" class="form-control" name="limitCount" min="1">
            </div>
            <div class="mb-3">
                <label class="form-label">Poster URL</label>
                <input type="url" class="form-control" name="imageUrl">
            </div>
            <button type="submit" class="btn btn-primary">Create Event</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('enrollmentType').addEventListener('change', function() {
            document.getElementById('limitCountDiv').style.display = 
                this.value === 'count' ? 'block' : 'none';
        });

        document.getElementById('createEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const token = getToken();
            
            if (!token) {
                alert('Please login first');
                window.location.href = '/';
                return;
            }

            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Format time
            data.applyStartTime = formatDateTime(data.applyStartTime);
            data.applyEndTime = formatDateTime(data.applyEndTime);
            data.startTime = formatDateTime(data.startTime);
            data.endTime = formatDateTime(data.endTime);

            try {
                console.log('Creating event with data:', data);
                console.log('Formatted times - applyStartTime:', data.applyStartTime, 'startTime:', data.startTime);
                
                const response = await fetch('/event/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const responseText = await response.text();
                console.log('Response status:', response.status);
                console.log('Response text:', responseText);
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Parsed response:', result);
                        if (result.code === 0 || (result.data !== undefined && result.data === true)) {
                            alert('Event created successfully!');
                            window.location.href = '/event/manage';
                        } else {
                            alert('Failed to create: ' + (result.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        // 如果返回的是纯布尔值
                        if (responseText === 'true') {
                            alert('Event created successfully!');
                            window.location.href = '/event/manage';
                        } else {
                            alert('Failed to create: ' + responseText);
                        }
                    }
                } else {
                    try {
                        const error = JSON.parse(responseText);
                        alert('Failed to create: ' + (error.msg || error.message || 'HTTP ' + response.status));
                    } catch (e) {
                        alert('Failed to create: HTTP ' + response.status);
                    }
                }
            } catch (error) {
                console.error('Failed to create event:', error);
                alert('Failed to create: ' + error.message);
            }
        });

        function getToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'token') {
                    return value;
                }
            }
            return null;
        }

        function formatDateTime(dateTimeStr) {
            // 将 datetime-local 格式转换为 yyyy-MM-dd HH:mm:ss
            if (!dateTimeStr) return '';
            
            // datetime-local 输入框的格式可能是：
            // - yyyy-MM-ddTHH:mm (没有秒)
            // - yyyy-MM-ddTHH:mm:ss (有秒，如果 step="1")
            
            // 替换 T 为空格
            let formatted = dateTimeStr.replace('T', ' ');
            
            // 检查是否已经有秒数部分（格式：HH:mm:ss）
            const timePattern = /(\d{2}:\d{2})(:\d{2})?$/;
            const match = formatted.match(timePattern);
            
            if (match) {
                if (match[2]) {
                    // 已经有秒数部分，直接返回
                    return formatted;
                } else {
                    // 没有秒数部分，添加 :00
                    return formatted + ':00';
                }
            }
            
            // 如果格式不匹配，尝试添加 :00
            return formatted + ':00';
        }
    </script>
</body>
</html>


